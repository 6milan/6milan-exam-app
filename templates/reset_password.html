<!-- templates/reset_password.html -->
{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}
{% block content %}
<div class="card shadow">
    <div class="card-body p-5">
        <h2 class="text-center mb-4">Reset Your Password</h2>
        <div id="reset-form">
            <form id="reset-password-form">
                <!-- New Password -->
                <div class="mb-3">
                    <label for="password" class="form-label">New Password</label>
                    <div class="input-group">
                        <input type="password" id="password" class="form-control" required minlength="6">
                        <div class="input-group-text bg-white border-start-0">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="show-password">
                                <label class="form-check-label text-muted small" for="show-password">
                                    Show
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Confirm Password -->
                <div class="mb-4">
                    <label for="confirm" class="form-label">Confirm Password</label>
                    <div class="input-group">
                        <input type="password" id="confirm" class="form-control" required>
                        <div class="input-group-text bg-white border-start-0">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="show-confirm">
                                <label class="form-check-label text-muted small" for="show-confirm">
                                    Show
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-success btn-lg">
                        Reset Password
                    </button>
                </div>
            </form>
        </div>
        <div id="success-message" class="text-center d-none">
            <div class="alert alert-success">
                <h4>Password Reset Successful!</h4>
                <p>Your password has been updated.</p>
                <a href="{{ url_for('login') }}" class="btn btn-primary mt-3">Go to Login</a>
            </div>
        </div>
        <div id="error-message" class="text-center d-none">
            <div class="alert alert-danger">
                <h4>Reset Failed</h4>
                <p id="error-text">An error occurred. Please try again.</p>
                <a href="{{ url_for('forgot_password') }}" class="btn btn-outline-secondary mt-3">Request New Link</a>
            </div>
        </div>
    </div>
</div>

<!-- Supabase JS + Reset Logic -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Initialize Supabase client
    const supabase = Supabase.createClient(
        '{{ config.SUPABASE_URL }}',
        '{{ config.SUPABASE_ANON_KEY }}'
    );

    const form = document.getElementById('reset-password-form');
    const successDiv = document.getElementById('success-message');
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    // Show/Hide toggles
    document.getElementById('show-password').addEventListener('change', function () {
        const field = document.getElementById('password');
        field.type = this.checked ? 'text' : 'password';
    });

    document.getElementById('show-confirm').addEventListener('change', function () {
        const field = document.getElementById('confirm');
        field.type = this.checked ? 'text' : 'password';
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm').value;

        if (password !== confirm) {
            errorText.textContent = "Passwords do not match.";
            form.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            return;
        }
        if (password.length < 6) {
            errorText.textContent = "Password must be at least 6 characters.";
            form.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            return;
        }

        try {
            const { data, error } = await supabase.auth.updateUser({
                password: password
            });
            if (error) throw error;

            form.classList.add('d-none');
            successDiv.classList.remove('d-none');
        } catch (error) {
            errorText.textContent = error.message || "Failed to reset password.";
            form.classList.add('d-none');
            errorDiv.classList.remove('d-none');
        }
    });

    // Auto-focus password field
    document.getElementById('password').focus();
</script>
{% endblock %}