<!-- templates/exam.html -->
{% extends "base.html" %}
{% block title %}{{ display_title or (category + ' Exam') }}{% endblock %}

{% block content %}
<div class="card shadow">
    <!-- Timer Header with Progress Bar & Section Info -->
    <div class="card-header bg-primary text-white position-relative overflow-hidden">
        <!-- Animated Progress Bar -->
        <div id="timer-bar" class="position-absolute top-0 start-0 h-100" 
             style="width: 100%; background-color: #28a745; transition: width 1s linear, background-color 0.5s;"></div>

        <div class="position-relative d-flex justify-content-between align-items-center py-3">
            <div>
                <h3 class="mb-1">{{ display_title or category.replace('_', ' ').title() }} Exam</h3>
                {% if section %}
                <span class="badge bg-light text-dark fs-6">{{ section.replace('section', 'Section ').title() }}</span>
                {% endif %}
            </div>
            <div class="text-end">
                <h4 id="timer" class="mb-1">
                    Time Remaining: <span id="time-display" class="fw-bold">00:00</span>
                </h4>
                <div>
                    <small class="me-2">{{ num_questions }} questions</small>
                    <small>‚Ä¢ {{ total_time_seconds // 60 }} minute{{ 's' if (total_time_seconds // 60) != 1 else '' }}</small>
                </div>
                {% if section_author and section_author != "Unknown Author" %}
                <div class="mt-1">
                    <small class="text-light">
                        üìù Questions prepared by: <strong>{{ section_author }}</strong>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card-body p-5">
        <div class="alert alert-info mb-5">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>
                    <strong>Instructions:</strong> Answer all {{ num_questions }} questions carefully! 
                    The exam will auto-submit when time ends.
                    {% if section == 'section1' %}
                    <span class="badge bg-primary ms-2">Section 1 (Questions 1-20)</span>
                    {% elif section == 'section2' %}
                    <span class="badge bg-success ms-2">Section 2 (Questions 21-100)</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <form id="exam-form" method="POST" novalidate>
            {{ form.hidden_tag() }}

            {% for field in form if field.name not in ['csrf_token', 'submit'] %}
                <div class="question-card mb-5 p-4 border rounded bg-light shadow-sm">
                    <div class="question-number mb-3">
                        <span class="badge bg-primary rounded-pill px-3 py-2 fs-6">
                            Q{{ loop.index }} / {{ num_questions }}
                        </span>
                    </div>
                    <p class="question-text fs-5 fw-bold mb-4">{{ field.label.text }}</p>
                    <div class="options">
                        {% for subfield in field %}
                            <div class="form-check mb-3 px-3 py-2 border-start border-3 border-primary hover-border">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label fs-6") }}
                            </div>
                        {% endfor %}
                    </div>
                    {% if field.errors %}
                        <div class="alert alert-danger mt-3 p-2">{{ field.errors[0] }}</div>
                    {% endif %}
                </div>
            {% endfor %}

            <div class="text-center mt-5 pt-4 border-top">
                <button type="submit" class="btn btn-success btn-lg px-5 py-3 fs-5">
                    <i class="bi bi-check-circle me-2"></i>Submit Exam
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.question-card:hover {
    background-color: #f8f9ff;
    transition: background-color 0.2s ease;
}
.form-check:hover {
    background-color: #e3f2fd;
    border-radius: 0.375rem;
    transition: background-color 0.15s ease;
}
.form-check input:checked + .form-check-label {
    font-weight: 600;
    color: #2563eb;
}
</style>

<!-- Timer & Progress Bar Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const totalSeconds = {{ total_time_seconds }};
    let timeLeft = totalSeconds;

    const timerDisplay = document.getElementById('time-display');
    const timerBar = document.getElementById('timer-bar');
    const examForm = document.getElementById('exam-form');

    function updateTimer() {
        if (timeLeft <= 0) {
            timerDisplay.textContent = "00:00";
            timerBar.style.width = "0%";
            timerBar.style.backgroundColor = "#dc3545";
            if (confirm("Time's up! Submit your exam now?")) {
                examForm.submit();
            }
            return;
        }

        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Update progress bar width
        const percentage = (timeLeft / totalSeconds) * 100;
        timerBar.style.width = `${percentage}%`;

        // Color change based on time left
        if (percentage > 50) {
            timerBar.style.backgroundColor = '#28a745'; // Green
        } else if (percentage > 20) {
            timerBar.style.backgroundColor = '#ffc107'; // Yellow
        } else {
            timerBar.style.backgroundColor = '#dc3545'; // Red
        }

        timeLeft--;
        setTimeout(updateTimer, 1000);
    }

    // Start timer on page load
    updateTimer();

    // Add hover effects for better UX
    document.querySelectorAll('.form-check').forEach(check => {
        check.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
        });
        check.addEventListener('mouseleave', function() {
            if (!this.querySelector('input').checked) {
                this.style.backgroundColor = '';
            }
        });
    });
</script>
{% endblock %}
